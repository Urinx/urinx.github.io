~function(){"use strict";var a=function(a){return document.querySelector(a)},b=function(a){this.file=null,this.audioContext=null,this.source=null,this.canvas=[],this.opts=a,this.drawOpts=[],this.drawFunc=[],this.sourceNode=null,this._init(a),Object.seal(this)};b.prototype={_init:function(b){var c=this,d=a(b.input),e=a(b.drag),f=b.load,g=[].concat(b.canvas),h=[].concat(b.draw_conf);return g.map(function(b,d){c.canvas.push(a(b)),c.drawOpts.push(c._initDraw(h[d],d)),c.drawFunc.push(c._initDrawFunc(h[d].type))}),c.isAudioContextSupported()?(c.audioContext=new window.AudioContext,d&&c.inputEventBind(d,function(a){c.file=a,c._start()}),e&&c.dragEventBind(e,function(a){c.file=a,c._start()}),f&&c._xhrLoadSound(f),void 0):!1},_xhrLoadSound:function(a){var b=this,c=new Promise(function(b){var d=new XMLHttpRequest;d.open("GET",a,!0),d.responseType="arraybuffer",d.onload=function(){b(d.response)},d.send()});c.then(function(a){b._audioDecode(a)})},_start:function(){var a=this,b=new FileReader;b.onload=function(b){var c=b.target.result;a._audioDecode(c)},b.readAsArrayBuffer(a.file)},_stop:function(){this.sourceNode.stop()},_audioDecode:function(a){var b=this,c=b.audioContext;c.decodeAudioData(a,function(a){b._initRender(c,a)},function(){console.log("Decode failed")})},_initRender:function(a,b){var c=a.createBufferSource(),d=a.createAnalyser();this.sourceNode=c,c.connect(d),d.connect(a.destination),c.buffer=b,c.start(0),this._render(d,this.drawOpts,this.drawFunc)},_render:function(a,b,c){var d=function(){var e=new Uint8Array(a.frequencyBinCount);a.getByteFrequencyData(e),c.map(function(a,c){a(e.subarray(0,730),b[c])}),requestAnimationFrame(d)};requestAnimationFrame(d)},_initDraw:function(a,b){var g,h,c=this.canvas[b],d=c.width,e=c.height,f=c.getContext("2d");if("histogram"===a.type)if(h=a.grad,g=f.createLinearGradient(0,0,0,e),"string"==typeof h)g.addColorStop(1,h);else for(b=0;b<h.length;b++)g.addColorStop(b/(h.length-1),h[b]);return this.extend({w:d,h:e,ctx:f,gradient:g},a)},_initDrawFunc:function(a){var b={histogram:this.draw_histogram,pie:this.draw_pie,foldline:this.draw_foldline,line:this.draw_line};return b[a]||"histogram"},draw_line:function(a,b){var m,n,o,c=b.w,d=b.h,e=b.ctx,f=b.lineWidth,g=c*b.k,h=b.n,i=b.color,j=d/2,k=c/(h+1),l=Math.floor(a.length/h);for(e.clearRect(0,0,c,d),e.lineWidth=f,e.strokeStyle=i,e.beginPath(),e.moveTo(0,j),e.lineTo(c,j),m=1;h>=m;m++)n=g+k*m,o=j+Math.pow(-1,m)*(a[l*m]%j),e.moveTo(n,j),e.lineTo(n,o);e.lineTo(c,j),e.closePath(),e.stroke()},draw_foldline:function(a,b){var m,n,o,c=b.w,d=b.h,e=b.ctx,f=b.lineWidth,g=c*b.k,h=b.n,i=b.color,j=d/2,k=c/(h+1),l=Math.floor(a.length/h);for(e.clearRect(0,0,c,d),e.lineWidth=f,e.strokeStyle=i,e.beginPath(),e.moveTo(0,j),e.lineTo(g,j),m=1;h>=m;m++)n=g+k*m,o=j+Math.pow(-1,m)*(a[l*m]%j),e.lineTo(n,o);e.lineTo(c,j),e.closePath(),e.stroke()},draw_pie:function(a,b){var c=b.w,d=b.h,e=b.ctx,g=(b.gradient,b.color),h=b.lineWidth,i=b.gap,j=c/2,k=d/2,l=k>j?j-h:k-h,m=a[10]%l;e.clearRect(0,0,c,d),e.fillStyle=g,e.beginPath(),e.moveTo(j+m,k),e.arc(j,k,m,0,2*Math.PI,!0),e.closePath(),e.fill(),e.strokeStyle=g,e.lineWidth=h,e.beginPath(),e.moveTo(j+m+i,k),e.arc(j,k,m+i,0,2*Math.PI,!0),e.closePath(),e.stroke()},draw_histogram:function(a,b){var n,o,c=b.w,d=b.h,e=b.ctx,f=b.gradient,g=b.meterWidth,h=b.capHeight,i=b.capStyle,j=b.gap,k=c/(g+j),l=[],m=Math.round(a.length/k);for(e.clearRect(0,0,c,d),n=0;k>n;n++)o=a[n*m]>d?d:a[n*m],l.length<Math.round(k)&&l.push(o),e.fillStyle=i,o<l[n]?e.fillRect(12*n,d- --l[n],g,h):(e.fillRect(12*n,d-o,g,h),l[n]=o),e.fillStyle=f,e.fillRect(12*n,d-o+h,g,d)},inputEventBind:function(a,b){var d,c={change:function(){0!==this.files.length&&b(this.files[0])}};for(d in c)a.addEventListener(d,c[d],!1)},dragEventBind:function(a,b){var d,c={dragenter:function(){console.log("Drop it on the page")},dragover:function(a){a.stopPropagation(),a.preventDefault(),a.dataTransfer.dropEffect="copy"},drop:function(a){console.log("Drop down"),a.stopPropagation(),a.preventDefault(),b(a.dataTransfer.files[0])}};for(d in c)a.addEventListener(d,c[d],!1)},isAudioContextSupported:function(){window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext,window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame;try{new window.AudioContext}catch(b){return console.log("Your browser does not support AudioContext!"),!1}return!0},extend:function(){var a=Array.prototype.slice.call(arguments);if("string"==typeof a[0])return a.join("");if(a[0]instanceof Array)return a.reduce(function(a,b){return a.concat(b)});if(a[0]instanceof Object)return a.reduce(function(a,b){for(var c in b)a[c]=b[c];return a});throw new Error("can not be extend")}},"object"==typeof exports?module.exports=b:"function"==typeof define&&define.amd?define(function(){return b}):window.Muzik=b}();